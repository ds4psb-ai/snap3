🚀 **CURSOR → ClaudeCode: GPT-5 Pro CTO Cloud Run 성능 튜닝 승인 및 지시사항**

**타임스탬프**: 2025-08-21 11:10 KST
**우선순위**: P0 (Critical - 즉시 실행)
**예상 소요**: 30분 집중 구현

---

## 📊 **GPT-5 Pro CTO 승인 및 우선순위**

### ✅ **승인된 작업**
- **즉시 Cloud Run 성능 튜닝** 진행 승인
- **Vertex 백업엔진(8082) 완성**은 병행·후순위로 권고

### 🎯 **우선순위 근거**
- **주엔진이 정상**(≈55s)이며, 튜닝은 UX/안정성/비용에 즉효·저리스크
- **백업엔진**은 요청 스키마(`contents`)와 키만 맞추면 완성 가시적
- **Cloud Run 설정**은 서비스 단위로 실시간 반영 가능

---

## 🛠 **T3 메인/서브 공통 런북 (Cloud Run 튜닝)**

### **A. 컨테이너 포트/헬스엔드포인트**

#### **서버 바인드 수정**
```javascript
// Express 등에서
app.listen(process.env.PORT || 8080, '0.0.0.0') // 127.0.0.1 금지
```

#### **헬스체크 경로**
- **Readiness**: `/readyz` (준비 상태)
- **Liveness**: `/healthz` (생존 상태)
- **Cloud Run 헬스체크 프로브**를 HTTP로 설정

### **B. 권장 파라미터 (VDP 생성형 워크로드 기준)**

#### **성능 최적화 설정**
- **Concurrency**: `3` (CPU 집약·외부 API 대기 혼합 워크로드의 안정 해상도)
- **Timeout**: `120s` (현재 p95≈55s 여유, Cloud Run 허용 1–3600s)
- **Min instances**: `1` (주엔진), `0–1`(서브) — 콜드스타트 방지
- **CPU/메모리**: `--cpu=2 --memory=2Gi` + **Startup CPU Boost** 권장
- **Billing 모드**: 기본은 **요청 기반** 유지

### **C. 적용 스크립트 (서비스별 실행)**

#### **t2-vdp-main (주엔진)**
```bash
gcloud run services update t2-vdp-main \
  --concurrency=3 --timeout=120 \
  --min-instances=1 --max-instances=10 \
  --cpu=2 --memory=2Gi --cpu-boost \
  --region=us-central1
```

#### **t2-vdp-sub (백업엔진)**
```bash
gcloud run services update t2-vdp-sub \
  --concurrency=3 --timeout=120 \
  --min-instances=0 --max-instances=5 \
  --cpu=2 --memory=2Gi --cpu-boost \
  --region=us-central1
```

### **D. 트래픽 스플릿 배포/회귀 (무중단)**

#### **점진적 롤아웃**
```bash
# 현행 리비전 100% 유지 후 새 리비전 무중단 시험
gcloud run services update-traffic t2-vdp-main --to-latest=10 --region=us-central1

# 문제가 없으면
gcloud run services update-traffic t2-vdp-main --to-latest=100 --region=us-central1

# 회귀 필요 시
gcloud run services update-traffic t2-vdp-main --to-revisions=REV_GOOD=100 --region=us-central1
```

---

## 🔧 **Vertex 백업엔진(8082) 완성 가이드**

### **필수 스키마**
```javascript
// @google/genai (예시)
const ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY });
const res = await ai.models.generateContent({
  model: "gemini-2.0-flash",
  contents: [{role:"user", parts:[{text: "VDP 생성 지시 프롬프트"}]}],
  // 필요 시: generationConfig, safetySettings ...
});
```

### **400/422 디버그 체크리스트**
1. `contents[]` 누락/형식 오류 → 400 (해결됨)
2. 컨테이너가 `$PORT` 미수신/내부 3001 고정 → 리비전 불건전/헬스 실패
3. 요청이 120초를 넘고 Node 기본 타임아웃 120초 영향 → 서버 타임아웃 조정

---

## 🧩 **팀별 즉시 액션 (승인 후 바로 수행)**

### **T1 (Main UI/API)**
1. **서버 바인드 `$PORT` 재점검** (도커·코드 동시) — 고정 포트 제거
2. **`/healthz`, `/readyz` 응답 200/503 정확화** (내부 종속성 체크 포함)

### **T2 (Worker)**
1. **VDP-Lite 폴백 유지** (성공률 100% 안전장치)
2. **Evidence 15s 지문**은 **옵션**으로 유지 (튜닝 이후 적용)

### **T3 (VDP Engines: main/sub)**
1. **gcloud 런북 적용** (Concurrency/Timeout/MinInstances/CPU)
2. **Vertex(8082) 요청 스키마 고정** (`contents[]`) + 키/권한 재검증

### **T4 (Loader/Storage)**
1. **변경 없음**. 트래픽 스플릿 중 양 리비전 산출물 모두 적재 검증 (관측만)

---

## 🚨 **운영 안전망 (필수 최소치)**

### **헬스체크 표준화**
- `/readyz` 준비 OK, `/healthz` 생존 OK
- Cloud Run **Readiness/Liveness** 프로브 연결

### **배포 전략**
- 리비전 **트래픽 스플릿** + 태그 (비가동 리비전 실험)

### **지표 (MVP 최소)**
- `request_count`, `error_count`, `latency_p95`, `concurrency`, `cold_start_count`

### **Eventarc 재시도/DLQ**
- at-least-once + **Dead-letter Topic** 구성 시 영구 실패 보존/재처리 가능 (MVP 이후 적용 권장)

---

## 🎯 **실행 체크리스트**

### **Phase 1: 컨테이너 포트 수정 (10분)**
- [ ] **서버 바인드**: `app.listen(process.env.PORT || 8080, '0.0.0.0')`
- [ ] **고정 포트 제거**: 코드/도커 양쪽에서 하드코드 제거
- [ ] **헬스체크 경로**: `/readyz`, `/healthz` 정확화

### **Phase 2: Cloud Run 설정 적용 (15분)**
- [ ] **t2-vdp-main**: concurrency=3, timeout=120, min-instances=1
- [ ] **t2-vdp-sub**: concurrency=3, timeout=120, min-instances=0
- [ ] **CPU/메모리**: --cpu=2 --memory=2Gi --cpu-boost

### **Phase 3: 트래픽 스플릿 테스트 (5분)**
- [ ] **무중단 배포**: 10% → 100% 점진 승격
- [ ] **롤백 경로**: 즉시 회귀 가능 확인

---

## 💬 **ClaudeCode 확인 요청사항**

1. **컨테이너 포트 수정** - `$PORT` 수신 재검증 (포트 충돌/헬스 실패 방지)
2. **Cloud Run 설정 적용** - gcloud 스크립트 실행
3. **트래픽 스플릿 배포** - 점진 롤아웃/즉시 롤백 경로 확보
4. **Node 런타임 타임아웃** - 120s 타임아웃 관찰 (필요 시 `server.setTimeout(0)` 명시)

**목표**: 30분 내 Cloud Run 성능 튜닝 완료 및 안정화 확인

---

**GPT-5 Pro CTO 세션**: Cloud Run 성능 튜닝 승인 완료
**다음 단계**: ClaudeCode 구현 → 트래픽 스플릿 테스트 → 성능 최적화 완료
