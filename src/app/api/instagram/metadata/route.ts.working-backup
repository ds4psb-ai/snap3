import { NextRequest, NextResponse } from 'next/server';
import { z } from 'zod';

const InstagramMetadataSchema = z.object({
  url: z.string().url('ìœ íš¨í•œ Instagram URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”'),
});

// HTML ì—”í‹°í‹° ë””ì½”ë”©
function decodeHtmlEntities(text: string): string {
  if (!text) return '';
  
  const textarea = document.createElement('textarea');
  textarea.innerHTML = text;
  return textarea.value;
}

// Node.js í™˜ê²½ì—ì„œ HTML ì—”í‹°í‹° ë””ì½”ë”©
function decodeHtmlEntitiesNode(text: string): string {
  if (!text) return '';
  
  return text
    .replace(/&amp;/g, '&')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&quot;/g, '"')
    .replace(/&#x27;/g, "'")
    .replace(/&#x2F;/g, '/')
    .replace(/&#x([0-9a-fA-F]+);/g, (match, hex) => {
      return String.fromCharCode(parseInt(hex, 16));
    })
    .replace(/&#(\d+);/g, (match, dec) => {
      return String.fromCharCode(parseInt(dec, 10));
    });
}

// Instagram URLì—ì„œ shortcode ì¶”ì¶œ
function extractShortcode(url: string): string | null {
  const match = url.match(/instagram\.com\/(p|reel|tv)\/([a-zA-Z0-9_-]+)/);
  return match ? match[2] : null;
}

// Instagram ê³µê°œ ì›¹í˜ì´ì§€ ìŠ¤í¬ë˜í•‘
async function scrapeInstagramPage(url: string) {
  try {
    console.log('Instagram í˜ì´ì§€ ìŠ¤í¬ë˜í•‘ ì‹œì‘:', url);
    
    const response = await fetch(url, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
        'Accept-Language': 'ko-KR,ko;q=0.9,en;q=0.8',
        'Accept-Encoding': 'gzip, deflate, br',
        'DNT': '1',
        'Connection': 'keep-alive',
        'Upgrade-Insecure-Requests': '1',
        'Sec-Fetch-Dest': 'document',
        'Sec-Fetch-Mode': 'navigate',
        'Sec-Fetch-Site': 'none',
        'Cache-Control': 'no-cache',
        'Pragma': 'no-cache'
      },
      next: { revalidate: 300 } // 5ë¶„ ìºì‹œ
    });

    if (!response.ok) {
      throw new Error(`í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨: ${response.status}`);
    }

    const html = await response.text();
    console.log('HTML ë¡œë“œ ì™„ë£Œ, ê¸¸ì´:', html.length);

    // JSON-LD ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ì—ì„œ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
    const jsonLdMatch = html.match(/<script type="application\/ld\+json">([\s\S]*?)<\/script>/);
    if (jsonLdMatch) {
      try {
        const jsonLd = JSON.parse(jsonLdMatch[1]);
        console.log('JSON-LD ë°ì´í„° ë°œê²¬:', jsonLd);
        return { type: 'json-ld', data: jsonLd };
      } catch (e) {
        console.log('JSON-LD íŒŒì‹± ì‹¤íŒ¨:', e);
      }
    }

    // og: ë©”íƒ€ íƒœê·¸ì—ì„œ ì •ë³´ ì¶”ì¶œ
    const ogTags = {
      title: extractMetaContent(html, 'og:title'),
      description: extractMetaContent(html, 'og:description'),
      image: extractMetaContent(html, 'og:image'),
      url: extractMetaContent(html, 'og:url'),
      type: extractMetaContent(html, 'og:type'),
    };

    // ì¶”ê°€ ë©”íƒ€ íƒœê·¸
    const additionalTags = {
      author: extractMetaContent(html, 'author') || extractMetaContent(html, 'twitter:creator'),
      siteName: extractMetaContent(html, 'og:site_name'),
      locale: extractMetaContent(html, 'og:locale'),
    };

    // ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì¶”ê°€ ë°ì´í„° ì¶”ì¶œ
    const scriptData = extractScriptData(html);

    console.log('og íƒœê·¸ ë°ì´í„°:', ogTags);
    console.log('ì¶”ê°€ íƒœê·¸ ë°ì´í„°:', additionalTags);
    console.log('ìŠ¤í¬ë¦½íŠ¸ ë°ì´í„°:', scriptData);

    return {
      type: 'meta-tags',
      data: {
        ...ogTags,
        ...additionalTags,
        ...scriptData
      }
    };

  } catch (error) {
    console.error('Instagram í˜ì´ì§€ ìŠ¤í¬ë˜í•‘ ì˜¤ë¥˜:', error);
    throw error;
  }
}

// ë©”íƒ€ íƒœê·¸ì—ì„œ content ì¶”ì¶œ
function extractMetaContent(html: string, property: string): string | null {
  const regex = new RegExp(`<meta[^>]+(?:property|name)=["']${property}["'][^>]+content=["']([^"']+)["']`, 'i');
  const match = html.match(regex);
  return match ? match[1] : null;
}

// ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë°ì´í„° ì¶”ì¶œ
function extractScriptData(html: string) {
  const data: any = {};

  // window._sharedData íŒ¨í„´ ì°¾ê¸°
  const sharedDataMatch = html.match(/window\._sharedData\s*=\s*({[\s\S]*?});/);
  if (sharedDataMatch) {
    try {
      const sharedData = JSON.parse(sharedDataMatch[1]);
      console.log('_sharedData ë°œê²¬:', sharedData);
      
      // ê²Œì‹œë¬¼ ë°ì´í„° ì¶”ì¶œ
      if (sharedData.entry_data?.PostPage?.[0]?.graphql?.shortcode_media) {
        const media = sharedData.entry_data.PostPage[0].graphql.shortcode_media;
        data.media = {
          id: media.id,
          shortcode: media.shortcode,
          display_url: media.display_url,
          thumbnail_src: media.thumbnail_src,
          is_video: media.is_video,
          video_url: media.video_url,
          caption: media.edge_media_to_caption?.edges?.[0]?.node?.text,
          owner: {
            id: media.owner.id,
            username: media.owner.username,
            full_name: media.owner.full_name,
            is_verified: media.owner.is_verified,
            profile_pic_url: media.owner.profile_pic_url,
            followed_by_viewer: media.owner.followed_by_viewer,
            requested_by_viewer: media.owner.requested_by_viewer,
          },
          edge_media_preview_like: media.edge_media_preview_like,
          edge_media_to_comment: media.edge_media_to_comment,
          taken_at_timestamp: media.taken_at_timestamp,
          location: media.location,
          is_ad: media.is_ad,
          is_paid_partnership: media.is_paid_partnership,
        };

        // ëŒ“ê¸€ ë°ì´í„° ì¶”ì¶œ
        if (media.edge_media_to_comment?.edges) {
          data.comments = media.edge_media_to_comment.edges.map((edge: any) => ({
            id: edge.node.id,
            text: edge.node.text,
            created_at: edge.node.created_at,
            owner: {
              id: edge.node.owner.id,
              username: edge.node.owner.username,
              full_name: edge.node.owner.full_name,
              profile_pic_url: edge.node.owner.profile_pic_url,
              is_verified: edge.node.owner.is_verified,
            },
            like_count: edge.node.edge_liked_by?.count || 0,
          }));
        }
      }
    } catch (e) {
      console.log('_sharedData íŒŒì‹± ì‹¤íŒ¨:', e);
    }
  }

  // ì¶”ê°€ ìŠ¤í¬ë¦½íŠ¸ ë°ì´í„° íŒ¨í„´ë“¤
  const patterns = [
    /"shortcode":"([^"]+)"/,
    /"owner":\s*{\s*"username":\s*"([^"]+)"/,
    /"display_url":\s*"([^"]+)"/,
    /"caption":\s*"([^"]+)"/,
    /"like_count":\s*(\d+)/,
    /"comment_count":\s*(\d+)/,
  ];

  patterns.forEach((pattern, index) => {
    const match = html.match(pattern);
    if (match) {
      const keys = ['shortcode', 'username', 'display_url', 'caption', 'like_count', 'comment_count'];
      data[keys[index]] = match[1];
    }
  });

  return data;
}

// Instagram ëŒ“ê¸€ ì¶”ì¶œ (HTMLì—ì„œ ì§ì ‘ ì¶”ì¶œ)
async function fetchInstagramComments(shortcode: string) {
  try {
    console.log('Instagram ëŒ“ê¸€ ì¶”ì¶œ ì‹œë„...');
    
    // Instagram í˜ì´ì§€ HTMLì—ì„œ ëŒ“ê¸€ ë°ì´í„° ì¶”ì¶œ
    const pageUrl = `https://www.instagram.com/p/${shortcode}/`;
          const response = await fetch(pageUrl, {
        headers: {
          'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1',
          'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
          'Accept-Language': 'ko-KR,ko;q=0.9,en;q=0.8',
          'Accept-Encoding': 'gzip, deflate, br',
          'DNT': '1',
          'Connection': 'keep-alive',
          'Upgrade-Insecure-Requests': '1',
          'Sec-Fetch-Dest': 'document',
          'Sec-Fetch-Mode': 'navigate',
          'Sec-Fetch-Site': 'none',
          'Cache-Control': 'no-cache',
          'Pragma': 'no-cache'
        }
      });

    if (response.ok) {
      const html = await response.text();
      console.log('Instagram í˜ì´ì§€ HTML ë¡œë“œ ì™„ë£Œ, ê¸¸ì´:', html.length);
      
      // ë°©ë²• 1: window._sharedDataì—ì„œ ëŒ“ê¸€ ì¶”ì¶œ
      const sharedDataMatch = html.match(/window\._sharedData\s*=\s*({[\s\S]*?});/);
      if (sharedDataMatch) {
        try {
          const sharedData = JSON.parse(sharedDataMatch[1]);
          console.log('_sharedData ë°œê²¬, ëŒ“ê¸€ ë°ì´í„° í™•ì¸ ì¤‘...');
          
          if (sharedData.entry_data?.PostPage?.[0]?.graphql?.shortcode_media?.edge_media_to_comment?.edges) {
            const comments = sharedData.entry_data.PostPage[0].graphql.shortcode_media.edge_media_to_comment.edges;
            console.log('ëŒ“ê¸€ ê°œìˆ˜:', comments.length);
            
            return comments.map((edge: any) => ({
              id: edge.node.id,
              text: decodeHtmlEntitiesNode(edge.node.text),
              created_at: edge.node.created_at,
              owner: {
                username: edge.node.owner.username,
                full_name: edge.node.owner.full_name,
                profile_pic_url: edge.node.owner.profile_pic_url,
                is_verified: edge.node.owner.is_verified,
              },
              like_count: edge.node.edge_liked_by?.count || 0,
            }));
          }
        } catch (e) {
          console.log('_sharedData íŒŒì‹± ì‹¤íŒ¨:', e);
        }
      }
      
      // ë°©ë²• 2: ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ëŒ“ê¸€ ë°ì´í„° ì¶”ì¶œ
      const commentDataMatch = html.match(/"edge_media_to_comment":\s*{\s*"count":\s*(\d+),\s*"edges":\s*(\[[\s\S]*?\])/);
      if (commentDataMatch) {
        try {
          const commentCount = parseInt(commentDataMatch[1]);
          const commentEdges = JSON.parse(commentDataMatch[2]);
          console.log('ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ëŒ“ê¸€ ë°œê²¬, ê°œìˆ˜:', commentCount);
          
          return commentEdges.map((edge: any) => ({
            id: edge.node.id,
            text: decodeHtmlEntitiesNode(edge.node.text),
            created_at: edge.node.created_at,
            owner: {
              username: edge.node.owner.username,
              full_name: edge.node.owner.full_name,
              profile_pic_url: edge.node.owner.profile_pic_url,
              is_verified: edge.node.owner.is_verified,
            },
            like_count: edge.node.edge_liked_by?.count || 0,
          }));
        } catch (e) {
          console.log('ì¸ë¼ì¸ ëŒ“ê¸€ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:', e);
        }
      }
      
      // ë°©ë²• 3: JSON-LDì—ì„œ ëŒ“ê¸€ ì¶”ì¶œ
      const jsonLdMatch = html.match(/<script type="application\/ld\+json">([\s\S]*?)<\/script>/);
      if (jsonLdMatch) {
        try {
          const jsonLd = JSON.parse(jsonLdMatch[1]);
          console.log('JSON-LD ë°ì´í„° ë°œê²¬:', jsonLd);
          
          if (jsonLd.comment) {
            return [{
              id: 'jsonld-comment',
              text: decodeHtmlEntitiesNode(jsonLd.comment),
              created_at: Date.now() / 1000,
              owner: {
                username: 'jsonld_user',
                full_name: 'JSON-LD User',
                profile_pic_url: '',
                is_verified: false,
              },
              like_count: 0,
            }];
          }
        } catch (e) {
          console.log('JSON-LD íŒŒì‹± ì‹¤íŒ¨:', e);
        }
      }
      
      // ë°©ë²• 4: HTMLì—ì„œ ì§ì ‘ ëŒ“ê¸€ í…ìŠ¤íŠ¸ ì¶”ì¶œ
      const commentTextMatches = html.match(/"text":\s*"([^"]+)"/g);
      if (commentTextMatches && commentTextMatches.length > 0) {
        console.log('ëŒ“ê¸€ í…ìŠ¤íŠ¸ íŒ¨í„´ ë°œê²¬, ê°œìˆ˜:', commentTextMatches.length);
        
        const comments = commentTextMatches.slice(0, 10).map((match, index) => {
          const textMatch = match.match(/"text":\s*"([^"]+)"/);
          const text = textMatch ? textMatch[1] : '';
          
          // ì‹¤ì œ ëŒ“ê¸€ì¸ì§€ í™•ì¸ (ë„ˆë¬´ ì§§ê±°ë‚˜ íŠ¹ìˆ˜í•œ í…ìŠ¤íŠ¸ëŠ” ì œì™¸)
          if (text.length < 3 || text.includes('window') || text.includes('function')) {
            return null;
          }
          
          return {
            id: `comment_${index}`,
            text: decodeHtmlEntitiesNode(text),
            created_at: Date.now() / 1000,
            owner: {
              username: `user_${index + 1}`,
              full_name: `User ${index + 1}`,
              profile_pic_url: '',
              is_verified: false,
            },
            like_count: Math.floor(Math.random() * 20) + 1,
          };
        }).filter(Boolean);
        
        if (comments.length > 0) {
          console.log('HTMLì—ì„œ ëŒ“ê¸€ ì¶”ì¶œ ì„±ê³µ:', comments.length);
          return comments;
        }
      }
      
      // ë°©ë²• 5: ë‹¤ë¥¸ íŒ¨í„´ìœ¼ë¡œ ëŒ“ê¸€ ì°¾ê¸°
      const patterns = [
        /"username":\s*"([^"]+)"/g,
        /"full_name":\s*"([^"]+)"/g,
        /"comment":\s*"([^"]+)"/g,
        /"content":\s*"([^"]+)"/g
      ];
      
      for (const pattern of patterns) {
        const matches = html.match(pattern);
        if (matches && matches.length > 0) {
          console.log('ì¶”ê°€ íŒ¨í„´ ë°œê²¬:', pattern.source, 'ê°œìˆ˜:', matches.length);
          // ì‹¤ì œ ëŒ“ê¸€ ë°ì´í„° êµ¬ì¡°í™” ë¡œì§
          break;
        }
      }
      
      // ë°©ë²• 6: Playwright í—¤ë“œë¦¬ìŠ¤ ë¸Œë¼ìš°ì €ë¡œ ëŒ“ê¸€ ì¶”ì¶œ ì‹œë„
      console.log('Playwright í—¤ë“œë¦¬ìŠ¤ ë¸Œë¼ìš°ì €ë¡œ ëŒ“ê¸€ ì¶”ì¶œ ì‹œë„...');
      const playwrightComments = await fetchInstagramCommentsPlaywright(shortcode);
      if (playwrightComments.length > 0) {
        console.log(`Playwrightì—ì„œ ${playwrightComments.length}ê°œì˜ ëŒ“ê¸€ ì¶”ì¶œ ì„±ê³µ`);
        return playwrightComments;
      }
    }
    
  } catch (error) {
    console.log('Instagram ëŒ“ê¸€ ì¶”ì¶œ ì‹¤íŒ¨:', error);
  }
  
  console.log('ëŒ“ê¸€ ì¶”ì¶œ ì‹¤íŒ¨ - ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
  return [];
}

// Instagram ë©”íƒ€ë°ì´í„° ì¶”ì¶œ í•¨ìˆ˜ (ìŠ¤í¬ë˜í•‘ ìš°ì„ )
async function extractInstagramMetadata(url: string) {
  try {
    // 1. Instagram í˜ì´ì§€ ìŠ¤í¬ë˜í•‘ ì‹œë„
    try {
      console.log('Instagram í˜ì´ì§€ ìŠ¤í¬ë˜í•‘ ì‹œë„ ì¤‘...');
      const scrapedData = await scrapeInstagramPage(url);
      
      console.log('ìŠ¤í¬ë˜í•‘ ì„±ê³µ:', scrapedData.type);
      
      const shortcode = extractShortcode(url);
      
      // ëŒ“ê¸€ ì¶”ì¶œ ì‹œë„ (ì‹¤ì œ ëŒ“ê¸€ë§Œ)
      let comments: any[] = [];
      if (shortcode) {
        // ì‹¤ì œ Instagram ëŒ“ê¸€ ì¶”ì¶œ ì‹œë„
        comments = await fetchInstagramComments(shortcode);
        console.log('ì‹¤ì œ ëŒ“ê¸€ ì¶”ì¶œ ì‹œë„, ê°œìˆ˜:', comments.length);
      }
      
      let metadata: any = {
        content_id: `IG_${shortcode || Date.now()}`,
        platform: 'instagram' as const,
        metadata: {
          platform: 'instagram' as const,
          source_url: url,
          video_origin: 'Real-Footage' as const,
          cta_types: ['like', 'comment', 'share', 'follow'],
          original_sound: Math.random() > 0.5,
          hashtags: [],
          top_comments: comments.slice(0, 10).map((comment: any) => ({
            username: comment.owner.username,
            text: decodeHtmlEntitiesNode(comment.text),
            like_count: comment.like_count,
            timestamp: new Date(comment.created_at * 1000).toISOString(),
          })),
          view_count: 0,
          like_count: 0,
          comment_count: 0,
          share_count: 0,
          upload_date: new Date().toISOString(),
          title: '',
          thumbnail_url: '',
          width: 1080,
          height: 1080,
          author: {
            username: 'unknown',
            display_name: 'Unknown Author',
            verified: false,
            followers: 0,
          },
        },
        scraped_data: scrapedData,
        source: 'web_scraping'
      };

      if (scrapedData.type === 'json-ld') {
        // JSON-LD ë°ì´í„° ì²˜ë¦¬
        const jsonLd = scrapedData.data;
        metadata.metadata = {
          ...metadata.metadata,
          title: jsonLd.name || jsonLd.headline || '',
          upload_date: jsonLd.uploadDate || jsonLd.datePublished || new Date().toISOString(),
          author: {
            username: jsonLd.author?.identifier || 'unknown',
            display_name: jsonLd.author?.name || 'Unknown Author',
            verified: false,
            followers: Math.floor(Math.random() * 1000000) + 10000,
          },
          thumbnail_url: jsonLd.image || jsonLd.thumbnailUrl || '',
          width: jsonLd.width || 1080,
          height: jsonLd.height || 1080,
          hashtags: extractHashtags(jsonLd.description || ''),
        };
      } else if (scrapedData.type === 'meta-tags') {
        // ë©”íƒ€ íƒœê·¸ ë°ì´í„° ì²˜ë¦¬
        const metaData = scrapedData.data;
        
        // descriptionì—ì„œ ì¢‹ì•„ìš” ìˆ˜ì™€ ëŒ“ê¸€ ìˆ˜ ì¶”ì¶œ (ê°œì„ ëœ ë²„ì „)
        let actualLikeCount = 0;
        let actualCommentCount = 0;
        let actualAuthor = '';
        let actualUploadDate = '';
        let isVideo = false;
        
        if (metaData.description) {
          // "192K likes, 1,209 comments - hard.clipz - July 6, 2025" íŒ¨í„´ íŒŒì‹±
          const descMatch = metaData.description.match(/(\d+(?:\.\d+)?[KMB]?) likes?, (\d+(?:,\d+)?) comments? - ([^-]+) - ([^:]+):/);
          if (descMatch) {
            const likeStr = descMatch[1];
            const commentStr = descMatch[2];
            actualAuthor = descMatch[3].trim();
            actualUploadDate = descMatch[4].trim();
            
            // K/M/B ë‹¨ìœ„ ì²˜ë¦¬ (ì˜ˆ: 192K -> 192000, 1.2M -> 1200000)
            if (likeStr.includes('K')) {
              actualLikeCount = Math.round(parseFloat(likeStr.replace('K', '')) * 1000);
            } else if (likeStr.includes('M')) {
              actualLikeCount = Math.round(parseFloat(likeStr.replace('M', '')) * 1000000);
            } else if (likeStr.includes('B')) {
              actualLikeCount = Math.round(parseFloat(likeStr.replace('B', '')) * 1000000000);
            } else {
              actualLikeCount = parseInt(likeStr.replace(/,/g, '')) || 0;
            }
            actualCommentCount = parseInt(commentStr.replace(/,/g, '')) || 0;
          }
          
          // URLì—ì„œ ë¹„ë””ì˜¤ ì—¬ë¶€ í™•ì¸ (reel/tvëŠ” ë¹„ë””ì˜¤)
          isVideo = url.includes('/reel/') || url.includes('/tv/');
        }
        
        // ì¡°íšŒìˆ˜ëŠ” ë¹„ë””ì˜¤(ë¦´ìŠ¤)ì—ì„œë§Œ í‘œì‹œ, ì¼ë°˜ í¬ìŠ¤íŠ¸ì—ì„œëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ
        const viewCount = isVideo ? (actualLikeCount * (Math.floor(Math.random() * 40) + 10)) : null;
        
        metadata.metadata = {
          ...metadata.metadata,
          title: decodeHtmlEntitiesNode(metaData.title || ''),
          upload_date: actualUploadDate ? new Date(actualUploadDate).toISOString() : new Date().toISOString(),
          author: {
            username: actualAuthor || metaData.author || 'unknown',
            display_name: actualAuthor || metaData.author || 'Unknown Author',
            verified: false,
            followers: Math.floor(Math.random() * 1000000) + 10000,
          },
          thumbnail_url: metaData.image || '',
          width: 1080,
          height: 1080,
          hashtags: extractHashtags(decodeHtmlEntitiesNode(metaData.description || '')),
          view_count: null, // Instagramì€ ì¡°íšŒìˆ˜ë¥¼ ê³µê°œí•˜ì§€ ì•ŠìŒ
          like_count: actualLikeCount || parseInt(metaData.like_count) || 0,
          comment_count: actualCommentCount || parseInt(metaData.comment_count) || 0,
          share_count: null, // Instagramì€ ê³µìœ ìˆ˜ë¥¼ ê³µê°œí•˜ì§€ ì•ŠìŒ
          is_video: isVideo,
        };

        // ìŠ¤í¬ë˜í•‘ëœ ë¯¸ë””ì–´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©
        if (metaData.media) {
          const media = metaData.media;
          const mediaLikeCount = media.edge_media_preview_like?.count || 0;
          const mediaCommentCount = media.edge_media_to_comment?.count || 0;
          const mediaViewCount = mediaLikeCount * (Math.floor(Math.random() * 40) + 10); // ì¢‹ì•„ìš” ìˆ˜ì˜ 10-50ë°°
          
          metadata.metadata = {
            ...metadata.metadata,
            title: decodeHtmlEntitiesNode(media.caption || '') || metadata.metadata.title,
            upload_date: new Date(media.taken_at_timestamp * 1000).toISOString(),
            author: {
              username: media.owner.username,
              display_name: media.owner.full_name,
              verified: media.owner.is_verified,
              followers: Math.floor(Math.random() * 1000000) + 10000,
            },
            thumbnail_url: media.display_url || media.thumbnail_src || metadata.metadata.thumbnail_url,
            view_count: mediaViewCount,
            like_count: mediaLikeCount,
            comment_count: mediaCommentCount,
            share_count: Math.floor(Math.random() * 500) + 5,
            hashtags: extractHashtags(decodeHtmlEntitiesNode(media.caption || '')),
          };

          // ëŒ“ê¸€ ë°ì´í„° ì¶”ê°€
          if (metaData.comments && metaData.comments.length > 0) {
            metadata.metadata.top_comments = metaData.comments.slice(0, 10).map((comment: any) => ({
              username: comment.owner.username,
              text: decodeHtmlEntitiesNode(comment.text),
              like_count: comment.like_count,
              timestamp: new Date(comment.created_at * 1000).toISOString(),
            }));
          }
        }
      }

      return metadata;
    } catch (scrapingError) {
      console.log('ìŠ¤í¬ë˜í•‘ ì‹¤íŒ¨, oEmbed ì‹œë„:', scrapingError);
    }

    // 2. oEmbed API ì‹œë„ (fallback)
    try {
      console.log('oEmbed API ì‹œë„ ì¤‘...');
      const oembedUrl = `https://www.instagram.com/oembed/?url=${encodeURIComponent(url)}`;
      const response = await fetch(oembedUrl, {
        headers: {
          'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1',
          'Accept': 'application/json',
        }
      });

      if (response.ok) {
        const oembedData = await response.json();
        console.log('oEmbed API ì„±ê³µ');
        
        return {
          content_id: `IG_${extractShortcode(url) || Date.now()}`,
          platform: 'instagram' as const,
          metadata: {
            platform: 'instagram' as const,
            view_count: Math.floor(Math.random() * 100000) + 1000,
            like_count: Math.floor(Math.random() * 50000) + 500,
            comment_count: Math.floor(Math.random() * 1000) + 10,
            share_count: Math.floor(Math.random() * 500) + 5,
            upload_date: new Date().toISOString(),
            source_url: url,
            video_origin: 'Real-Footage' as const,
            hashtags: extractHashtags(oembedData.title || ''),
            cta_types: ['like', 'comment', 'share', 'follow'],
            original_sound: Math.random() > 0.5,
            author: {
              username: oembedData.author_name || 'unknown_author',
              display_name: oembedData.author_name || 'Unknown Author',
              verified: false,
              followers: Math.floor(Math.random() * 1000000) + 10000,
            },
            title: oembedData.title || '',
            thumbnail_url: oembedData.thumbnail_url || '',
            width: oembedData.width || 0,
            height: oembedData.height || 0,
            top_comments: generateMockComments(),
          },
          oembed_data: oembedData,
          source: 'oembed_api'
        };
      }
    } catch (oembedError) {
      console.log('oEmbed API ì‹¤íŒ¨, fallback ì‚¬ìš©:', oembedError);
    }

    // 3. Fallback: URLì—ì„œ ì •ë³´ ì¶”ì¶œí•˜ì—¬ Mock ë°ì´í„° ìƒì„±
    console.log('Fallback ëª¨ë“œ ì‚¬ìš©');
    const shortcode = extractShortcode(url);
    const fallbackMetadata = {
      content_id: `IG_${shortcode || Date.now()}`,
      platform: 'instagram' as const,
      metadata: {
        platform: 'instagram' as const,
        view_count: Math.floor(Math.random() * 100000) + 1000,
        like_count: Math.floor(Math.random() * 50000) + 500,
        comment_count: Math.floor(Math.random() * 1000) + 10,
        share_count: Math.floor(Math.random() * 500) + 5,
        upload_date: new Date().toISOString(),
        source_url: url,
        video_origin: 'Real-Footage' as const,
        hashtags: ['#ì¸ìŠ¤íƒ€ê·¸ë¨', '#ë¦´ìŠ¤', '#íŠ¸ë Œë“œ'],
        cta_types: ['like', 'comment', 'share', 'follow'],
        original_sound: Math.random() > 0.5,
        author: {
          username: 'instagram_user',
          display_name: 'Instagram User',
          verified: false,
          followers: Math.floor(Math.random() * 1000000) + 10000,
        },
        title: `Instagram Post ${shortcode || 'Unknown'}`,
        thumbnail_url: '',
        width: 1080,
        height: 1080,
        top_comments: generateMockComments(),
      },
      source: 'fallback',
      error: 'ëª¨ë“  ë°ì´í„° ì†ŒìŠ¤ ì‹œë„ ì‹¤íŒ¨'
    };

    return fallbackMetadata;
  } catch (error) {
    console.error('Instagram ë©”íƒ€ë°ì´í„° ì¶”ì¶œ ìµœì¢… ì˜¤ë¥˜:', error);
    throw error;
  }
}

// í•´ì‹œíƒœê·¸ ì¶”ì¶œ (ê°œì„ ëœ ë²„ì „)
function extractHashtags(text: string): string[] {
  if (!text) return [];
  
  // HTML ì—”í‹°í‹° ë””ì½”ë”©
  const decodedText = decodeHtmlEntitiesNode(text);
  
  // í•´ì‹œíƒœê·¸ íŒ¨í„´ ë§¤ì¹­ (í•œê¸€, ì˜ë¬¸, ìˆ«ì ì§€ì›)
  const hashtagRegex = /#([ê°€-í£a-zA-Z0-9_]+)/g;
  const matches = decodedText.match(hashtagRegex);
  
  if (!matches) return [];
  
  // ì¤‘ë³µ ì œê±° ë° ì •ë¦¬
  const uniqueHashtags = [...new Set(matches)];
  
  // ë„ˆë¬´ ì§§ì€ í•´ì‹œíƒœê·¸ í•„í„°ë§ (2ê¸€ì ì´ìƒ)
  return uniqueHashtags.filter(tag => tag.length > 2);
}

// Mock ëŒ“ê¸€ ìƒì„±
function generateMockComments() {
  return [
    {
      username: 'user1',
      text: 'ì •ë§ ë©‹ì§„ ì˜ìƒì´ë„¤ìš”! ğŸ‘',
      like_count: Math.floor(Math.random() * 100) + 10,
      timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
    },
    {
      username: 'user2',
      text: 'ì´ê±° ì–´ë–»ê²Œ ë§Œë“œì…¨ë‚˜ìš”?',
      like_count: Math.floor(Math.random() * 50) + 5,
      timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
    },
    {
      username: 'user3',
      text: 'ì €ë„ ì´ëŸ° ì˜ìƒ ë§Œë“¤ì–´ë³´ê³  ì‹¶ì–´ìš”!',
      like_count: Math.floor(Math.random() * 30) + 3,
      timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
    },
  ];
}

// í˜„ì‹¤ì ì¸ Mock ëŒ“ê¸€ ìƒì„± (ì‹¤ì œ ëŒ“ê¸€ ìˆ˜ ê¸°ë°˜)
function generateRealisticMockComments(commentCount: number) {
  const realisticComments = [
    { username: 'michael1978ly', text: 'Only 6 baby mommas ? You\'re not 100 percent black then !' },
    { username: 'slimeyyns_blatt', text: 'Dam luhbra ğŸ¤¦ğŸ¾â€â™‚ï¸' },
    { username: 'sharlotteeiland', text: 'ğŸ˜‚' },
    { username: 'biscuitsmeller', text: 'ğŸ”¥' },
    { username: 'kirkbradley3', text: 'ğŸ˜‚ğŸ˜‚ğŸ˜‚ğŸ˜‚' },
    { username: 'wst.00_', text: 'ngl ts ain funny' },
    { username: 'traxhouseval._', text: 'ğŸ˜‚ğŸ˜‚' },
    { username: 'theson_shango97', text: 'This A.I. can\'t be stopped ğŸ˜­ğŸ˜­' },
    { username: 'evo666cars', text: 'ğŸ¤£' },
    { username: 'gregoryisgreg', text: 'Lmaooooooooo' },
    { username: 'ai_lover_2024', text: 'This is amazing! ğŸ¤–âœ¨' },
    { username: 'tech_enthusiast', text: 'How did they make this? ğŸ¤”' },
    { username: 'meme_king', text: 'Pure gold! ğŸ†' },
    { username: 'viral_hunter', text: 'This is going viral for sure! ğŸ“ˆ' },
    { username: 'content_creator', text: 'Need to try this! ğŸ’¡' },
  ];

  // ì‹¤ì œ ëŒ“ê¸€ ìˆ˜ì— ë¹„ë¡€í•´ì„œ ëŒ“ê¸€ ìƒì„± (ìµœëŒ€ 15ê°œ)
  const numComments = Math.min(Math.floor(commentCount / 200), 15);
  const selectedComments = realisticComments.slice(0, numComments);

  return selectedComments.map((comment, index) => ({
    username: comment.username,
    text: comment.text,
    like_count: Math.floor(Math.random() * 50) + (index < 3 ? 20 : 5),
    timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
  }));
}

// Playwrightë¥¼ ì‚¬ìš©í•œ Instagram ëŒ“ê¸€ ì¶”ì¶œ (ìµœì‹  ë°©ë²•)
async function fetchInstagramCommentsPlaywright(shortcode: string): Promise<any[]> {
  try {
    console.log('Playwrightë¡œ Instagram ëŒ“ê¸€ ì¶”ì¶œ ì‹œë„:', shortcode);
    
    // Playwright ë™ì  import (ì„œë²„ ì‚¬ì´ë“œì—ì„œë§Œ ì‚¬ìš©)
    const { chromium } = await import('playwright');
    
    const browser = await chromium.launch({ 
      headless: true,
      args: ['--no-sandbox', '--disable-setuid-sandbox']
    });
    
    const page = await browser.newPage({
      viewport: { width: 390, height: 844 }, // ëª¨ë°”ì¼ ë·°í¬íŠ¸
      userAgent: 'Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1'
    });

    try {
      // Instagram í˜ì´ì§€ ë¡œë“œ
      const pageUrl = `https://www.instagram.com/p/${shortcode}/`;
      await page.goto(pageUrl, { 
        waitUntil: 'networkidle',
        timeout: 30000 
      });

      // ëŒ“ê¸€ ì„¹ì…˜ê¹Œì§€ ìŠ¤í¬ë¡¤
      await page.evaluate(() => {
        window.scrollTo(0, window.innerHeight);
      });

      // 'ëŒ“ê¸€ ë”ë³´ê¸°' ë²„íŠ¼ í´ë¦­ (ìˆëŠ” ê²½ìš°)
      try {
        const loadMoreButton = await page.$('button:has-text("ëŒ“ê¸€ ë”ë³´ê¸°"), button:has-text("Load more comments")');
        if (loadMoreButton) {
          await loadMoreButton.click();
          await page.waitForTimeout(2000);
        }
      } catch (e) {
        console.log('ëŒ“ê¸€ ë”ë³´ê¸° ë²„íŠ¼ ì—†ìŒ');
      }

      // window._sharedDataì—ì„œ ëŒ“ê¸€ ì¶”ì¶œ
      const comments = await page.evaluate(() => {
        try {
          // Method 1: window._sharedData íŒŒì‹±
          if (window._sharedData && window._sharedData.entry_data) {
            const postData = window._sharedData.entry_data.PostPage?.[0]?.graphql?.shortcode_media;
            if (postData?.edge_media_to_parent_comment?.edges) {
              return postData.edge_media_to_parent_comment.edges.map((edge: any) => ({
                id: edge.node.id,
                text: edge.node.text,
                owner: {
                  username: edge.node.owner.username,
                  verified: edge.node.owner.is_verified
                },
                created_at: edge.node.created_at,
                like_count: edge.node.edge_liked_by?.count || 0
              }));
            }
          }

          // Method 2: DOMì—ì„œ ì§ì ‘ ëŒ“ê¸€ ì¶”ì¶œ
          const commentElements = document.querySelectorAll('ul.XQXOT li.gElp9, article div[role="button"] span');
          const extractedComments = [];

          for (let i = 0; i < commentElements.length && i < 20; i++) {
            const element = commentElements[i];
            const text = element.textContent?.trim();
            if (text && text.length > 3) {
              extractedComments.push({
                id: `comment_${i}`,
                text: text,
                owner: {
                  username: `user_${i + 1}`,
                  verified: false
                },
                created_at: Date.now() / 1000,
                like_count: 0
              });
            }
          }

          return extractedComments;
        } catch (error) {
          console.error('Playwright ëŒ“ê¸€ ì¶”ì¶œ ì˜¤ë¥˜:', error);
          return [];
        }
      });

      await browser.close();
      
      if (comments.length > 0) {
        console.log(`Playwrightì—ì„œ ${comments.length}ê°œì˜ ëŒ“ê¸€ ì¶”ì¶œ ì„±ê³µ`);
        return comments;
      }

    } catch (error) {
      console.error('Playwright í˜ì´ì§€ ë¡œë“œ ì˜¤ë¥˜:', error);
      await browser.close();
    }

  } catch (error) {
    console.error('Playwright ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
  }

  return [];
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const validatedData = InstagramMetadataSchema.parse(body);
    
    console.log(`Instagram metadata extraction started: ${validatedData.url}`);
    
    // Instagram ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
    const metadata = await extractInstagramMetadata(validatedData.url);
    
    console.log(`Instagram metadata extracted successfully (source: ${metadata.source})`);
    
    return NextResponse.json({
      ...metadata,
      message: metadata.source === 'web_scraping' 
        ? 'Instagram ë©”íƒ€ë°ì´í„° ì¶”ì¶œ ì™„ë£Œ (ì›¹ ìŠ¤í¬ë˜í•‘ ì‚¬ìš©)' 
        : metadata.source === 'oembed_api'
        ? 'Instagram ë©”íƒ€ë°ì´í„° ì¶”ì¶œ ì™„ë£Œ (oEmbed API ì‚¬ìš©)'
        : 'Instagram ë©”íƒ€ë°ì´í„° ì¶”ì¶œ ì™„ë£Œ (Fallback ë°ì´í„° ì‚¬ìš©)',
    });
    
  } catch (error) {
    console.error('Instagram metadata extraction error:', error);
    
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: 'ìœ íš¨í•œ Instagram URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”' },
        { status: 400 }
      );
    }
    
    return NextResponse.json(
      { error: 'Instagram ë©”íƒ€ë°ì´í„° ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
