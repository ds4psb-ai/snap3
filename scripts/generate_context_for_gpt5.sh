#!/usr/bin/env bash
set -euo pipefail

# GPT-5 Proìš© ì»¨í…ìŠ¤íŠ¸ ìƒì„± ìŠ¤í¬ë¦½íŠ¸
# ì‚¬ìš©ë²•: ./scripts/generate_context_for_gpt5.sh [--include-files] [--include-diff]

cd "$(git rev-parse --show-toplevel)"

# ì˜µì…˜ íŒŒì‹±
INCLUDE_FILES=false
INCLUDE_DIFF=false
OUTPUT_FILE=""

while [[ $# -gt 0 ]]; do
  case $1 in
    --include-files)
      INCLUDE_FILES=true
      shift
      ;;
    --include-diff)
      INCLUDE_DIFF=true
      shift
      ;;
    --output)
      OUTPUT_FILE="$2"
      shift 2
      ;;
    -h|--help)
      echo "Usage: $0 [OPTIONS]"
      echo "Options:"
      echo "  --include-files    Include changed files list"
      echo "  --include-diff     Include diff preview"
      echo "  --output FILE      Save to file instead of stdout"
      echo "  -h, --help         Show this help"
      exit 0
      ;;
    *)
      echo "Unknown option: $1"
      exit 1
      ;;
  esac
done

# ì¶œë ¥ í•¨ìˆ˜
output() {
  if [[ -n "$OUTPUT_FILE" ]]; then
    echo "$1" >> "$OUTPUT_FILE"
  else
    echo "$1"
  fi
}

# ì¶œë ¥ íŒŒì¼ ì´ˆê¸°í™”
if [[ -n "$OUTPUT_FILE" ]]; then
  > "$OUTPUT_FILE"
fi

# í—¤ë”
output "## ðŸŽ¯ GPT-5 Pro Context Summary"
output ""
output "**Generated**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
output "**Repository**: $(basename "$(git rev-parse --show-toplevel)")"
output "**Branch**: $(git branch --show-current)"
output "**HEAD**: $(git rev-parse --short HEAD)"
output ""

# ìµœê·¼ 5ì»¤ë°‹ ìš”ì•½
output "### ðŸ“‹ Recent 5 Commits"
output '```'
bash scripts/generate_summary.sh | while IFS= read -r line; do
  output "$line"
done
output '```'
output ""

# í˜„ìž¬ ìž‘ì—… ë””ë ‰í† ë¦¬ ìƒíƒœ
output "### ðŸ  Current Working State"
output "- **Working Directory**: \`$(pwd)\`"
output "- **Git Status**: $(git status --porcelain | wc -l) modified files"
output "- **Staged Changes**: $(git diff --cached --stat | tail -1 || echo "No staged changes")"
output "- **Unstaged Changes**: $(git diff --stat | tail -1 || echo "No unstaged changes")"
output ""

# ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ (ì˜µì…˜)
if [[ "$INCLUDE_FILES" == true ]]; then
  output "### ðŸ“ Changed Files (Last Commit)"
  output '```'
  git diff --name-only HEAD^ HEAD | head -20 | while IFS= read -r line; do
    output "$line"
  done
  output '```'
  output ""
fi

# Diff ë¯¸ë¦¬ë³´ê¸° (ì˜µì…˜)
if [[ "$INCLUDE_DIFF" == true ]]; then
  output "### ðŸ” Recent Changes Preview"
  output '```diff'
  git diff HEAD^ HEAD --patch-with-stat | head -50 | while IFS= read -r line; do
    output "$line"
  done
  output '```'
  output ""
fi

# í„°ë¯¸ë„ ìƒíƒœ ì²´í¬ ížŒíŠ¸
output "### ðŸ–¥ï¸ Terminal Status Commands"
output "```bash"
output "# Main T1 (~/snap3)"
output "cd ~/snap3 && scripts/generate_summary.sh"
output ""
output "# Jobs T2 (~/snap3-jobs)"  
output "cd ~/snap3-jobs && ./worker-ingest-v2.sh --health"
output ""
output "# T2VDP T3 (~/snap3/services/t2-extract)"
output "cd ~/snap3/services/t2-extract && ./run-all-checks.sh"
output ""
output "# Storage T4 (~/snap3-storage)"
output "cd ~/snap3-storage && ./scripts/quick-validation.sh"
output '```'
output ""

# í”„ë¡œì íŠ¸ í•µì‹¬ ì •ë³´
output "### ðŸŽ¯ Project Core Info"
output "- **Type**: VDP RAW Generation Pipeline"
output "- **Platforms**: YouTube, Instagram, TikTok"
output "- **Architecture**: Multi-terminal (4x), Platform-segmented GCS"
output "- **Key Bucket**: \`tough-variety-raw-central1\`"
output "- **Key Region**: \`us-central1\`"
output ""

# GPT-5 ì‚¬ìš© ê°€ì´ë“œ
output "### ðŸš€ GPT-5 Quick Start Instructions"
output "1. **Copy this entire output** to new GPT-5 Pro chat"
output "2. **Add prompt**: \"Use this context to guide ClaudeCode collaboration for VDP pipeline work\""
output "3. **Reference docs**: [Triangular Workflow](docs/GPT5_CLAUDECODE_CURSOR_TRIANGULAR_WORKFLOW.md)"
output "4. **Terminal setup**: Use the 4-terminal structure shown above"
output ""

# ì£¼ìš” ëª…ë ¹ì–´ ë ˆí¼ëŸ°ìŠ¤
output "### ðŸ”§ Key Commands Reference"
output "```bash"
output "# ì»¨í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸"
output "scripts/generate_context_for_gpt5.sh --include-files --output /tmp/gpt5_context.md"
output ""
output "# ì¸ì œìŠ¤íŠ¸ UI ì‹¤í–‰"
output "node simple-web-server.js  # http://localhost:8080"
output ""
output "# ë©”ì¸ UI ì‹¤í–‰"
output "npm run dev  # http://localhost:3000"
output ""
output "# ì „ì²´ ì‹œìŠ¤í…œ ê²€ì¦"
output "cd services/t2-extract && ./run-all-checks.sh"
output '```'
output ""

# í˜„ìž¬ í™˜ê²½ ë³€ìˆ˜ ìƒíƒœ
output "### âš™ï¸ Environment Status"
output "```bash"
output "PROJECT_ID=${PROJECT_ID:-'not_set'}"
output "REGION=${REGION:-'not_set'}" 
output "RAW_BUCKET=${RAW_BUCKET:-'not_set'}"
output "PLATFORM_SEGMENTED_PATH=${PLATFORM_SEGMENTED_PATH:-'not_set'}"
output '```'
output ""

# ìµœê·¼ ë¡œê·¸ íŒŒì¼ ìƒíƒœ 
if [[ -d "logs" ]]; then
  output "### ðŸ“ Recent Logs Status"
  output "```"
  ls -la logs/ | tail -5 | while IFS= read -r line; do
    output "$line"
  done 2>/dev/null || output "No logs directory or files"
  output '```'
  output ""
fi

# í‘¸í„°
output "---"
output "*ðŸ¤– Generated by \`scripts/generate_context_for_gpt5.sh\` â€¢ $(date)*"

# ì„±ê³µ ë©”ì‹œì§€
if [[ -n "$OUTPUT_FILE" ]]; then
  echo "âœ… Context summary saved to: $OUTPUT_FILE"
  echo "ðŸ“‹ Copy content to GPT-5 Pro for seamless collaboration!"
else
  echo "" >&2
  echo "âœ… Context summary generated!" >&2
  echo "ðŸ“‹ Copy the above output to GPT-5 Pro chat" >&2
fi