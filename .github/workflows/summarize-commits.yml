name: Auto Context Summary

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      include_files:
        description: 'Include changed files list'
        required: false
        default: 'true'
        type: boolean

jobs:
  context-summary:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 10  # ë” ë§ì€ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°

      - name: Generate Enhanced Context Summary
        id: summary
        run: |
          echo "## ğŸ¯ Context Summary for GPT-5 Pro" > context_summary.md
          echo "" >> context_summary.md
          
          # ê¸°ë³¸ ì •ë³´
          echo "**Event**: \`${{ github.event_name }}\`" >> context_summary.md
          echo "**Branch**: \`${{ github.ref_name }}\`" >> context_summary.md
          echo "**SHA**: \`${{ github.sha }}\`" >> context_summary.md
          echo "**Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> context_summary.md
          echo "" >> context_summary.md
          
          # ìµœê·¼ 5ì»¤ë°‹ ìš”ì•½ (ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ í™œìš©)
          echo "### ğŸ“‹ Recent 5 Commits" >> context_summary.md
          echo '```' >> context_summary.md
          bash scripts/generate_summary.sh >> context_summary.md
          echo '```' >> context_summary.md
          echo "" >> context_summary.md
          
          # PR ì •ë³´ (PRì¸ ê²½ìš°)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "### ğŸ”€ Pull Request Info" >> context_summary.md
            echo "**Title**: ${{ github.event.pull_request.title }}" >> context_summary.md
            echo "**Author**: @${{ github.event.pull_request.user.login }}" >> context_summary.md
            echo "**Target**: \`${{ github.event.pull_request.base.ref }}\` â† \`${{ github.event.pull_request.head.ref }}\`" >> context_summary.md
            echo "" >> context_summary.md
            
            # PR ë³€ê²½ í†µê³„
            echo "### ğŸ“Š PR Changes" >> context_summary.md
            echo '```' >> context_summary.md
            git diff ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} --stat >> context_summary.md
            echo '```' >> context_summary.md
            echo "" >> context_summary.md
          fi
          
          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ (ìµœëŒ€ 20ê°œ)
          if [ "${{ inputs.include_files || 'true' }}" = "true" ]; then
            echo "### ğŸ“ Changed Files" >> context_summary.md
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | head -20 > changed_files.tmp
            else
              git diff --name-only ${{ github.sha }}^ ${{ github.sha }} | head -20 > changed_files.tmp
            fi
            
            if [ -s changed_files.tmp ]; then
              echo '```' >> context_summary.md
              cat changed_files.tmp >> context_summary.md
              echo '```' >> context_summary.md
            else
              echo "*No files changed*" >> context_summary.md
            fi
            echo "" >> context_summary.md
          fi
          
          # ì£¼ìš” ë³€ê²½ì‚¬í•­ (íŒ¨ì¹˜ ë¯¸ë¦¬ë³´ê¸°)
          echo "### ğŸ” Key Changes Preview" >> context_summary.md
          echo '```diff' >> context_summary.md
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git diff ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} --patch-with-stat | head -40 >> context_summary.md
          else
            git diff ${{ github.sha }}^ ${{ github.sha }} --patch-with-stat | head -40 >> context_summary.md
          fi
          echo '```' >> context_summary.md
          echo "" >> context_summary.md
          
          # GPT-5 Quick Start ê°€ì´ë“œ (ì‚¼ê°í¸ëŒ€ í†µí•©)
          echo "### ğŸš€ GPT-5 Triangular Workflow" >> context_summary.md
          echo "#### For GPT-5 Pro (HEAD):" >> context_summary.md
          echo "1. **Copy this entire comment** to new GPT-5 chat" >> context_summary.md
          echo "2. **Add**: \`Use this context for ClaudeCode â†” Cursor triangular collaboration\`" >> context_summary.md
          echo "3. **Reference**: [Triangular Workflow Guide](https://github.com/${{ github.repository }}/blob/main/docs/GPT5_CLAUDECODE_CURSOR_TRIANGULAR_WORKFLOW.md)" >> context_summary.md
          echo "" >> context_summary.md
          echo "#### For ClaudeCode (main):" >> context_summary.md
          echo "- Use terminal commands above for project status" >> context_summary.md
          echo "- Focus on backend services and data processing" >> context_summary.md
          echo "- Generate context updates with \`scripts/generate_summary.sh\`" >> context_summary.md
          echo "" >> context_summary.md
          echo "#### For Cursor (sub):" >> context_summary.md
          echo "- Handle frontend development and UI components" >> context_summary.md
          echo "- Run \`npm run dev\` for Next.js development server" >> context_summary.md
          echo "- Use \`node simple-web-server.js\` for ingester UI (port 8080)" >> context_summary.md
          echo "- Test with Instagram/TikTok metadata extractor at \`/instagram-extractor\`" >> context_summary.md
          echo "" >> context_summary.md
          
          # í„°ë¯¸ë„ ìƒíƒœ íŒíŠ¸ (ClaudeCode + Cursor í†µí•©)
          echo "### ğŸ–¥ï¸ Terminal Status Hints" >> context_summary.md
          echo "#### ClaudeCode Terminals:" >> context_summary.md
          echo "- **Main T1**: \`cd ~/snap3 && scripts/generate_summary.sh\`" >> context_summary.md
          echo "- **Jobs T2**: \`cd ~/snap3-jobs && ./worker-ingest-v2.sh --health\`" >> context_summary.md
          echo "- **T2VDP T3**: \`cd ~/snap3/services/t2-extract && ./run-all-checks.sh\`" >> context_summary.md
          echo "- **Storage T4**: \`cd ~/snap3-storage && ./scripts/quick-validation.sh\`" >> context_summary.md
          echo "" >> context_summary.md
          echo "#### Cursor Integration:" >> context_summary.md
          echo "- **Development Server**: \`npm run dev\` (port 3000)" >> context_summary.md
          echo "- **Simple Web Server**: \`node simple-web-server.js\` (port 8080)" >> context_summary.md
          echo "- **Health Check**: \`curl http://localhost:8080/api/health\`" >> context_summary.md
          echo "- **Test Suite**: \`npm test\` or \`npm run test:ci\`" >> context_summary.md
          echo "" >> context_summary.md
          
          # ë§í¬ ëª¨ìŒ
          echo "### ğŸ”— Quick Links" >> context_summary.md
          echo "- [Repository](https://github.com/${{ github.repository }})" >> context_summary.md
          echo "- [Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> context_summary.md
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "- [Pull Request](https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }})" >> context_summary.md
          fi
          echo "- [Actions](https://github.com/${{ github.repository }}/actions)" >> context_summary.md
          
          # ë©˜ì…˜ ì¶”ê°€ (ìµœì¢… ì •ë¦¬)
          echo "" >> context_summary.md
          echo "---" >> context_summary.md
          echo "*ğŸ¤– Auto-generated by GitHub Actions â€¢ [View Workflow](https://github.com/${{ github.repository }}/blob/main/.github/workflows/summarize-commits.yml)*" >> context_summary.md

      # PRì— ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ ì½”ë©˜íŠ¸ ìƒì„±/ì—…ë°ì´íŠ¸
      - name: Create/Update PR Context Comment
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: context_summary.md
          comment-author: 'github-actions[bot]'
          comment-author-exclude: ''

      # main ë¸Œëœì¹˜ pushì‹œ ì»¤ë°‹ì— ì»¨í…ìŠ¤íŠ¸ ì½”ë©˜íŠ¸
      - name: Comment on Main Branch Commit  
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('context_summary.md', 'utf8');
            
            try {
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: body
              });
              console.log('âœ… Commit comment created successfully');
            } catch (error) {
              console.log('âš ï¸ Failed to create commit comment:', error.message);
            }

      # Artifactë¡œ ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ ì €ì¥ (ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥)
      - name: Upload Context Summary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: context-summary-${{ github.sha }}
          path: context_summary.md
          retention-days: 30