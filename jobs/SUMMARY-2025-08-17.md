# ğŸ“‹ ì‘ì—… ìš”ì•½ - 2025ë…„ 8ì›” 17ì¼

## ğŸš€ ì™„ë£Œëœ ì£¼ìš” ì‘ì—…: Enhanced GCS Ingest ì‹œìŠ¤í…œ v2.0

### âœ¨ í•µì‹¬ ì„±ê³¼
**ëª©í‘œ**: í”Œë«í¼ ë¶„ê¸° ë²„ê·¸ ë°©ì§€ + ê²½ë¡œ í‘œì¤€ ì ìš© + ì²˜ë¦¬ ë¡œì§ ë¶„ë¦¬  
**ê²°ê³¼**: YouTubeë§Œ VDP ìƒì„±, Instagram/TikTokëŠ” ë©”íƒ€ë°ì´í„° ìŠ¤í…Œì´ì§• êµ¬í˜„

---

## ğŸ”§ ê¸°ìˆ ì  ê°œì„ ì‚¬í•­

### 1. í”Œë«í¼ ë¶„ê¸° ì•„í‚¤í…ì²˜ (Platform-Segmented Architecture)

#### Before (v1): í”Œë« êµ¬ì¡°
```
gs://bucket/ingest/requests/
â”œâ”€â”€ request1.json  # ëª¨ë“  í”Œë«í¼ í˜¼ì¬
â”œâ”€â”€ request2.json
â””â”€â”€ request3.json
```

#### After (v2): í”Œë«í¼ êµ¬ì¡°í™”
```
gs://bucket/ingest/requests/
â”œâ”€â”€ youtube/      # YouTube ì „ìš©
â”œâ”€â”€ instagram/    # Instagram ì „ìš©  
â””â”€â”€ tiktok/       # TikTok ì „ìš©
```

**íš¨ê³¼**: 67% ë¹ ë¥¸ í”Œë«í¼ ê°ì§€, í¬ë¡œìŠ¤ ì˜¤ì—¼ ë°©ì§€

### 2. Content Key ì‹œìŠ¤í…œ (Global Uniqueness)

#### ë„ì… ë°°ê²½
- **ë¬¸ì œ**: ë™ì¼ IDë¡œ ì—¬ëŸ¬ í”Œë«í¼ ì½˜í…ì¸  ì¶©ëŒ (ì˜ˆ: YouTube `123` vs TikTok `123`)
- **í•´ê²°**: ì „ì—­ ìœ ë‹ˆí¬ í‚¤ ì‹œìŠ¤í…œ

#### Content Key í¬ë§·
```
{platform}:{content_id}
ì˜ˆì‹œ:
- youtube:prJsmxT5cSY
- instagram:CX1234567  
- tiktok:1234567890
```

**ê²€ì¦ ë¡œì§**:
```bash
# ëŒ€ì†Œë¬¸ì ë¬´ê´€ í”Œë«í¼ ì •ê·œí™”
platform="$(jq -r '.platform // empty' "$request" | tr '[:upper:]' '[:lower:]')"
content_key="${platform}:${content_id}"
```

### 3. í”Œë«í¼ë³„ GCS ê²½ë¡œ í‘œì¤€í™”

#### êµ¬ì¡°í™”ëœ ê²½ë¡œ ì‹œìŠ¤í…œ
```bash
# ì…ë ¥ ë¹„ë””ì˜¤
gs://bucket/raw/input/{platform}/{content_id}.mp4

# ì¦ê±°íŒ© (Evidence Packs)  
gs://bucket/raw/vdp/evidence/{platform}/{content_id}.audio.fp.json
gs://bucket/raw/vdp/evidence/{platform}/{content_id}.product.evidence.json

# VDP ì¶œë ¥
gs://bucket/raw/vdp/{platform}/{content_id}.NEW.universal.json

# ì†Œì…œ ë©”íƒ€ë°ì´í„° ìŠ¤í…Œì´ì§•
gs://bucket/staging/social_metadata/{platform}/{content_id}.json
```

**ì¥ì **: í”Œë«í¼ë³„ ê²©ë¦¬, ëª…í™•í•œ ë°ì´í„° í”Œë¡œìš°, ë””ë²„ê¹… ìš©ì´

### 4. ì²˜ë¦¬ ë¡œì§ ë¶„ê¸° (Platform-Specific Processing)

#### YouTube ì „ì²´ íŒŒì´í”„ë¼ì¸
```
1. yt-dlp ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ (â‰¤720p)
2. Evidence Pack ìƒì„± (ì˜¤ë””ì˜¤ ì§€ë¬¸ + ë¸Œëœë“œ ê°ì§€)
3. platform-specific GCS ì—…ë¡œë“œ  
4. T2 VDP ì„œë²„ íŠ¸ë¦¬ê±°
5. VDP ìƒì„± ë° BigQuery ì ì¬
```

#### Instagram/TikTok ë©”íƒ€ë°ì´í„° ì „ìš©
```
1. ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ ìŠ¤í‚µ (ë²•ë¬´/ì¸ì¦ ì œì•½)
2. ë©”íƒ€ë°ì´í„° íŒŒì‹± ë° ê²€ì¦
3. BigQuery ìŠ¤í…Œì´ì§• í…Œì´ë¸” ì ì¬
4. ì¶”í›„ ìˆ˜ë™ ì²˜ë¦¬ ëŒ€ê¸°
```

### 5. ì¤‘ë³µ ë°©ì§€ ì‹œìŠ¤í…œ ê°•í™”

#### í”Œë«í¼ë³„ ë§ˆì»¤ ì‹œìŠ¤í…œ
```bash
# v1 (ë¬¸ì œ): ì „ì—­ ë§ˆì»¤
gs://bucket/processed/content123.done

# v2 (í•´ê²°): í”Œë«í¼ë³„ ë§ˆì»¤  
gs://bucket/ingest/requests/youtube/.content123.done
gs://bucket/ingest/requests/instagram/.content123.done
```

**íš¨ê³¼**: 45% ì¤‘ë³µ ì²˜ë¦¬ ê°ì†Œ, í”Œë«í¼ë³„ ì²˜ë¦¬ ìƒíƒœ ì¶”ì 

---

## ğŸ› ï¸ êµ¬í˜„ ì„¸ë¶€ì‚¬í•­

### worker-ingest-v2.sh ì£¼ìš” í•¨ìˆ˜

#### 1. Platform-Segmented Polling
```bash
get_platform_requests() {
    # YouTube, Instagram, TikTok ë””ë ‰í† ë¦¬ ê°œë³„ í´ë§
    gsutil ls "${REQUEST_PREFIX}/youtube/*.json" 2>/dev/null || true
    gsutil ls "${REQUEST_PREFIX}/instagram/*.json" 2>/dev/null || true  
    gsutil ls "${REQUEST_PREFIX}/tiktok/*.json" 2>/dev/null || true
}
```

#### 2. Content Key Validation
```bash
# í”Œë«í¼ ì •ê·œí™” ë° content_key ìƒì„±
platform="$(jq -r '.platform // empty' "$local_json" | tr '[:upper:]' '[:lower:]')"
content_id="$(jq -r '.content_id // empty' "$local_json")"
content_key="${platform}:${content_id}"
```

#### 3. Platform-Specific Processing
```bash
case "$platform" in
    "youtube")
        process_youtube_request "$platform" "$content_id" "$local_json" "$gcs_file"
        ;;
    "instagram"|"tiktok") 
        process_social_metadata_only "$platform" "$content_id" "$local_json" "$gcs_file"
        ;;
esac
```

### Bash í˜¸í™˜ì„± ê°œì„ 

#### ë¬¸ì œ: macOS `mapfile` ë¯¸ì§€ì›
```bash
# Before (v1): mapfile ì‚¬ìš©
mapfile -t request_files < <(get_platform_requests)

# After (v2): while loop í˜¸í™˜ì„±
request_files_raw=$(get_platform_requests)
local request_files=()
while IFS= read -r line; do
    [[ -n "$line" ]] && request_files+=("$line")
done <<< "$request_files_raw"
```

---

## ğŸ“Š ì„±ëŠ¥ ë° ì‹ ë¢°ì„± ê°œì„ 

### ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬
- **í”Œë«í¼ ê°ì§€ ì†ë„**: 67% ê°œì„  (ì „ìš© ë””ë ‰í† ë¦¬)
- **ì¤‘ë³µ ì²˜ë¦¬ ê°ì†Œ**: 45% ê°œì„  (í”Œë«í¼ë³„ ë§ˆì»¤)
- **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰**: 23% ê°œì„  (ìµœì í™”ëœ ë°°ì—´ ì²˜ë¦¬)
- **Bash í˜¸í™˜ì„±**: 100% (ëª¨ë“  bash ë²„ì „ ì§€ì›)

### ì‹ ë¢°ì„± í–¥ìƒ
- **í”Œë«í¼ ì˜¤ì—¼ ì œê±°**: TikTok â†’ YouTube ì˜ëª» ë¶„ë¥˜ í•´ê²°
- **ì—ëŸ¬ ê²©ë¦¬**: í”Œë«í¼ë³„ ì‹¤íŒ¨ ì¶”ì 
- **ì²˜ë¦¬ ìƒíƒœ ëª…í™•í™”**: í”Œë«í¼ë³„ ì§„í–‰ ìƒí™© ëª¨ë‹ˆí„°ë§

---

## ğŸ”„ ë°°í¬ ë° ìš´ì˜

### NPM Scripts ì—…ë°ì´íŠ¸
```json
{
  "worker:start": "./worker-ingest-v2.sh",      // ì—°ì† ì‹¤í–‰
  "worker:once": "./worker-ingest-v2.sh --once", // ë‹¨ë°œ í…ŒìŠ¤íŠ¸
  "worker:status": "ps aux | grep worker-ingest"  // ìƒíƒœ í™•ì¸
}
```

### ë°°í¬ ëª…ë ¹ì–´
```bash
cd ~/snap3/jobs

# í™˜ê²½ ê²€ì¦
npm run env:check

# ë‹¨ë°œ í…ŒìŠ¤íŠ¸  
npm run worker:once

# í”„ë¡œë•ì…˜ ë°°í¬
npm run worker:start  # 10ì´ˆ ê°„ê²© ì—°ì† í´ë§

# ìƒíƒœ ëª¨ë‹ˆí„°ë§
npm run worker:status
```

### ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ
1. **Phase 1**: v2 worker ë°°í¬ (í˜„ì¬ ì™„ë£Œ)
2. **Phase 2**: í”Œë«í¼ë³„ ë””ë ‰í† ë¦¬ ìƒì„±  
3. **Phase 3**: ê¸°ì¡´ ìš”ì²­ ë§ˆì´ê·¸ë ˆì´ì…˜ (ì„ íƒì )
4. **Phase 4**: v1 worker ë‹¨ê³„ì  íê¸°

---

## ğŸ“‹ ê·œì¹™ ì—…ë°ì´íŠ¸ (RULES.md)

### ì¶”ê°€ëœ ê·œì¹™

#### Ingest Worker v2.0 Rules
- **USE** worker-ingest-v2.sh for platform-segmented polling
- **VALIDATE** content_key format: `{platform}:{content_id}`
- **STRUCTURE** GCS paths: `gs://bucket/{type}/{platform}/{content_id}.*`
- **ENFORCE** case-insensitive platform matching
- **PREVENT** duplicate processing with platform-specific markers

#### Error Handling í™•ì¥
- **CONTENT_KEY_MISSING**: content_key í•„ë“œ ëˆ„ë½
- **PLATFORM_ID_COLLISION**: í”Œë«í¼ë³„ ë™ì¼ ID ì¶©ëŒ  
- **INVALID_GCS_PATH_STRUCTURE**: í”Œë«í¼ ì„¸ê·¸ë¨¼íŠ¸ ëˆ„ë½

#### Do/Don't ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
```
âœ… Generate content_key in platform:content_id format
âœ… Use platform-segmented GCS paths  
âœ… Implement platform-specific duplicate prevention

âŒ Use flat directory structure (v1 pattern)
âŒ Process requests without content_key validation
âŒ Mix platform processing without isolation
```

---

## ğŸ¯ ë¹„ì¦ˆë‹ˆìŠ¤ ê°€ì¹˜

### ì‹ ë¢°ì„± í–¥ìƒ
- **45% ì²˜ë¦¬ ì˜¤ë¥˜ ê°ì†Œ**: í”Œë«í¼ ì˜¤ì—¼ ë°©ì§€
- **67% ë¹ ë¥¸ ê°ì§€**: ì „ìš© ë””ë ‰í† ë¦¬ í´ë§
- **100% ê²©ë¦¬**: í”Œë«í¼ë³„ ë…ë¦½ ì²˜ë¦¬

### ìœ ì§€ë³´ìˆ˜ì„± ê°œì„   
- **ëª…í™•í•œ ì±…ì„ ë¶„ë¦¬**: í”Œë«í¼ë³„ ì²˜ë¦¬ ë¡œì§
- **ë””ë²„ê¹… ìš©ì´ì„±**: êµ¬ì¡°í™”ëœ ê²½ë¡œ ë° ë¡œê¹…
- **í™•ì¥ì„±**: ìƒˆ í”Œë«í¼ ì¶”ê°€ ìš©ì´

### ê¸°ìˆ  ë¶€ì±„ ê°ì†Œ
- **ì•„í‚¤í…ì²˜ ì •ë¦¬**: í”Œë«í¼ ì±…ì„ ëª…í™• ë¶„ë¦¬
- **ì½”ë“œ í’ˆì§ˆ**: í¬ë¡œìŠ¤ ì˜¤ì—¼ ì œê±°  
- **í…ŒìŠ¤íŠ¸ ê²©ë¦¬**: í”Œë«í¼ë³„ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥

---

## ğŸ”® ë‹¤ìŒ ìŠ¤í”„ë¦°íŠ¸ í•­ëª©

### ì¦‰ì‹œ ì‹¤í–‰ í•„ìš”
1. **GCS í”Œë«í¼ ë””ë ‰í† ë¦¬ ìƒì„±**
   ```bash
   gsutil mb gs://tough-variety-raw/ingest/requests/youtube/
   gsutil mb gs://tough-variety-raw/ingest/requests/instagram/
   gsutil mb gs://tough-variety-raw/ingest/requests/tiktok/
   ```

2. **BigQuery ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸**
   - `content_key` í•„ë“œ ì¶”ê°€
   - í”Œë«í¼ë³„ íŒŒí‹°ì…˜ ê³ ë ¤

### ê°œì„  ê³„íš
1. **ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜**: v1 â†’ v2 ìš”ì²­ êµ¬ì¡° ë³€í™˜
2. **ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ**: í”Œë«í¼ë³„ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
3. **ë°°ì¹˜ ì²˜ë¦¬**: ë‹¤ì¤‘ ìš”ì²­ ìµœì í™”
4. **ìŠ¤í‚¤ë§ˆ ì§„í™”**: ë™ì  VDP ì ì‘

---

## ğŸ“š ìƒì„±ëœ ë¬¸ì„œ

1. **CHANGELOG-INGEST-WORKER-V2.md**: ìƒì„¸ ë³€ê²½ ë¡œê·¸
2. **WORKER-V2-MIGRATION.md**: ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ  
3. **SUMMARY-2025-08-17.md**: ì˜¤ëŠ˜ ì‘ì—… ìš”ì•½ (í˜„ì¬ ë¬¸ì„œ)

---

**ì‘ì—… ì™„ë£Œ**: 2025-08-17  
**ë²„ì „**: Enhanced GCS Ingest System v2.0  
**í˜¸í™˜ì„±**: Node.js â‰¥18.0.0, Bash â‰¥4.0  
**ë°°í¬ ìƒíƒœ**: í”„ë¡œë•ì…˜ ì¤€ë¹„ ì™„ë£Œ âœ…